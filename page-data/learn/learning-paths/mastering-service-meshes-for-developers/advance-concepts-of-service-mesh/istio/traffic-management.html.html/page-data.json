{"componentChunkName":"component---src-templates-learn-chapter-js-content-file-path-home-runner-work-layer-5-layer-5-content-learn-mastering-service-meshes-for-developers-advance-concepts-of-service-mesh-istio-traffic-management-mdx","path":"/learn/learning-paths/mastering-service-meshes-for-developers/advance-concepts-of-service-mesh/istio/traffic-management.html.html","result":{"data":{"chapter":{"body":"\n\n\n<ChapterStyle>\nService routes and version subsets should be in place given the destination rules applied in Lab 3. If they are not present, re-apply the destination rules:\n\n<br />\n\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: productpage\nspec:\n  host: productpage\n  subsets:\n    - name: v1\n      labels:\n        version: v1\n---\n\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\nname: reviews\nspec:\nhost: reviews\nsubsets: - name: v1\nlabels:\nversion: v1 - name: v2\nlabels:\nversion: v2 - name: v3\nlabels:\nversion: v3\n\n---\n\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\nname: ratings\nspec:\nhost: ratings\nsubsets: - name: v1\nlabels:\nversion: v1 - name: v2\nlabels:\nversion: v2 - name: v2-mysql\nlabels:\nversion: v2-mysql - name: v2-mysql-vm\nlabels:\nversion: v2-mysql-vm\n\n---\n\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\nname: details\nspec:\nhost: details\nsubsets: - name: v1\nlabels:\nversion: v1 - name: v2\nlabels:\nversion: v2\n\n---\n\n```\n\n<br />\n\n<h2 className=\"chapter-sub-heading\">\n  Start managing traffic routes\n</h2>\n\n\nSome basics to get us started.\n\n<h3 className=\"chapter-sub-heading\">\n   Send all requests to Productpage v1\n</h3>\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n\n\n```\n_Using Meshery, apply custom configuration._\n\nRefresh BookInfo productpage\n\n<h3 className=\"chapter-sub-heading\">\n   Send all requests to Productpage v2\n</h3>\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v2\n```\n_Using Meshery, apply custom configuration._\n\nRefresh BookInfo productpage.\n\n<h2 className=\"chapter-sub-heading\">\n   Traffic routing based on user or user-agent type\n</h2>\n\n<br/>\n\n<h3 className=\"chapter-sub-heading\">\n   Redirect requests from mobile devices\n</h3>\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: bookinfo\nspec:\n  hosts:\n    - \"bookinfo.meshery.io\"\n  gateways:\n    - sample-app-gateway\n  http:\n    - match:\n        - headers:\n            User-Agent:\n              regex: ^.*Mobile.*$\n      route:\n        - headers:\n            request:\n              set:\n                x-response: \"Success with Mobile\"\n          destination:\n            host: productpage\n            port:\n              number: 9080\n    - route:\n        - destination:\n            host: product\n            subset: random\n\n\n```\n\nSet your browser to mimic a mobile device. Enable Developer tools, if need. Refresh BookInfo productpage.\n\n<h3 className=\"chapter-sub-heading\">\n   Redirect requests based on HTTP header information\n</h3>\n\nExample of using user information from HTTP headers to redirect requests.\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - match:\n        - headers:\n            end-user:\n              exact: naruto\n      route:\n        - destination:\n            host: reviews\n            subset: v2\n    - match:\n        - headers:\n            end-user:\n              exact: sasuke\n      route:\n        - destination:\n            host: reviews\n            subset: v3\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n\n\n```\n\n<h2 className=\"chapter-sub-heading\">\n   Traffic Mirroring with Istio\n</h2>\n\nYou will need to generate load on BookInfo's productpage service. See Lab 4 for instructions for running a performance test.\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n          weight: 100\n      mirror:\n        host: reviews\n        subset: v2\n      mirror_percent: 100\n\n```\nIncrementally increase the traffic split percentage to the higher version service #. Start at 20% traffic split\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n          weight: 80\n        - destination:\n            host: reviews\n            subset: v3\n          weight: 20\n\n\n```\n\nMove to 50%. Observe in Meshery.\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n          weight: 50\n        - destination:\n            host: reviews\n            subset: v3\n          weight: 50\n\n```\n<h2 className=\"chapter-sub-heading\">\n   Injecting Latency\n</h2>\n\nAcknowledging the fallacy that the network is always reliable, you will intentionally cause a little chaos.\n\n<h3 className=\"chapter-sub-heading\">\n   Exploring timeouts with Reviews service\n</h3>\n\nNote Istio Proxy's default timeout settings.\n\n```yaml\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - match:\n        - headers:\n            end-user:\n              exact: naruto\n      fault:\n        delay:\n          percentage:\n            value: 100.0\n          fixedDelay: 11s\n      route:\n        - destination:\n            host: reviews\n            subset: v1\n    - route:\n        - destination:\n            host: reviews\n            subset: v2\n\n```\n\n<h3 className=\"chapter-sub-heading\">\n   Exploring timeouts with Ratings service\n</h3>\n\n```yaml\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n    - ratings\n  http:\n    - match:\n        - headers:\n            end-user:\n              exact: naruto\n      fault:\n        delay:\n          percentage:\n            value: 100.0\n          fixedDelay: 5s\n      route:\n        - destination:\n            host: ratings\n            subset: v1\n    - route:\n        - destination:\n            host: ratings\n            subset: v1\n\n```\n\n<h2 className=\"chapter-sub-heading\">\n    Retries\n</h2>\n\nOvercoming the latency issue.\n\n<h3 className=\"chapter-sub-heading\">\n    Set 5 retry attempts and a 3 second timeout\n</h3>\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n      retries:\n        attempts: 5\n        perTryTimeout: 3s\n\n```\n\n<br />\n<h3>Alternative: Manual installation</h3>\nFollow these steps if the above steps did not work\n<br />\n<br />\n\n<h4 className=\"chapter-alt-heading\"> Traffic management with Istio</h4>\n\nIf you haven't forked or cloned this repository, please do so now:\n\n```sh\ngit clone https://github.com/layer5io/advanced-istio-service-mesh-workshop\n\n```\n<h4 className=\"chapter-alt-heading\">\n  {\" \"}\n  Route all traffic to version V1 \n  \n</h4>\n\n```sh\nkubectl apply -f route-v1-v2/v1.yaml\n```\n<h4 className=\"chapter-alt-heading\">\n  {\" \"}\n  Route all traffic to version V2 \n  \n</h4>\n\n```sh\nkubectl apply -f route-v1-v2/v2.yaml\n```\n\n<h3 className=\"chapter-sub-heading\">\n \n  Traffic routing based on user or user-agent type\n</h3>\n\n<h4 className=\"chapter-alt-heading\"> Redirect requests from mobile devices</h4>\n\n```sh\nkubectl apply -f route-header/device.yaml\n```\n\n<h4 className=\"chapter-alt-heading\"> Redirect requests based on Cookie data </h4>\n\n```sh\nkubectl apply -f route-header/user.yaml\n```\n\n</ChapterStyle>\n","frontmatter":{"chapterTitle":"Traffic management","description":"Meshery is the cloud native management plane which offers lifecycle, configuration, and performance management of service meshes and their workloads."},"fields":{"slug":"learn/learning-paths/mastering-service-meshes-for-developers/advance-concepts-of-service-mesh/istio/traffic-management","course":"advance-concepts-of-service-mesh","learnpath":"mastering-service-meshes-for-developers","chapter":"traffic-management"}},"course":{"nodes":[{"frontmatter":{"courseTitle":"Advance Concepts of Service Meshes - Hands On","meshesYouLearn":[{"imagepath":{"childImageSharp":null,"extension":"svg","publicURL":"/static/731763d720780a49c2ffdfede8c28f4b/istio.svg"},"name":"Istio"},{"imagepath":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/webp;base64,UklGRl4CAABXRUJQVlA4WAoAAAAQAAAAEwAAEgAAQUxQSCsBAAABkK1t27FFd7Zt2y3WBti2bdvWmrHU0Q7YNbbtybZdz+D7/m2IiAkAY8hqnoBA3moIOFSBTPv19+/X7TJQYSm67VOG5X16pafcd1sEQNydhzdp5yCXnytw+exwJ4mXx118lV7aQLbj+psDROvOlwNsX9Iq9cze9CrB+iEN6EBvmG5ne4jeXf3aOcjm5wpePqsWhdOPq3dER/kC8h/oqx3E6s8X/bkE8g+J4mF+j0YfU7829EfonjniiWKw8dMFos/ptEoELj83EPPfbhq8Fi6ami4WvJC2y8EveqQFwyc//4timb27dlohXDz7XyRbsUTzxfwkyxOmB5owmiCmp9wiDLcnZcJoYRDhBlAfjdmmZzTnWTyL6Hqwz+7S1CTtzYJjz8eeXFyej72YAABWUDggDAEAANAGAJ0BKhQAEwA+0VykTqglIyIoCqkAGglsALsyhHtYgrcJsK8xLFfoAdLcXseXeC9VGgsgkUpjlH7xR/xXEADeLYf7CYczoIv9t/vBQKOfOllI+unz6A0lUpkyuYCaKrQ3V/cH/zwEMeMfwM3TEUaJUejIEnllgZV0KT+dRXgVwdljiM/5bOUho/K6UAbp3tBPzBB385WEFco7bcPG7AiNcgse0VFkQn/VypGu+AnTdSJIx1S2ryZdD/2XLOJ/2cfL0Hca9wb71w7I4H9Yu5BrsoDN2sW9vnwGPwP0y+vhwJpyyj8G2UOOH3E7diegyWWXc0Z6zTp5+P+Tfv1AmHIlVCYdE2okyAD9gAA="},"images":{"fallback":{"src":"/static/ca53815f6e4054379084f39f253f9a9d/2bba5/linkerd.webp","srcSet":"/static/ca53815f6e4054379084f39f253f9a9d/02e18/linkerd.webp 13w,\n/static/ca53815f6e4054379084f39f253f9a9d/04db5/linkerd.webp 25w,\n/static/ca53815f6e4054379084f39f253f9a9d/2bba5/linkerd.webp 50w,\n/static/ca53815f6e4054379084f39f253f9a9d/2d116/linkerd.webp 100w","sizes":"(min-width: 50px) 50px, 100vw"},"sources":[]},"width":50,"height":47}},"extension":"webp","publicURL":"/static/ca53815f6e4054379084f39f253f9a9d/linkerd.webp"},"name":"Linkerd"}]},"fields":{"slug":"learn/learning-paths/mastering-service-meshes-for-developers/advance-concepts-of-service-mesh"}}]},"TOC":{"nodes":[{"frontmatter":{"order":8,"chapterTitle":"Conclusion"},"fields":{"section":"istio","chapter":"conclusion"}},{"frontmatter":{"order":2,"chapterTitle":"Deploy a sample application"},"fields":{"section":"istio","chapter":"deploy-an-application"}},{"frontmatter":{"order":3,"chapterTitle":"Exposing services through Istio Ingress Gateway"},"fields":{"section":"istio","chapter":"expose-services"}},{"frontmatter":{"order":1,"chapterTitle":"Getting Started"},"fields":{"section":"istio","chapter":"getting-started"}},{"frontmatter":{"order":4,"chapterTitle":"Observability"},"fields":{"section":"istio","chapter":"observability"}},{"frontmatter":{"order":6,"chapterTitle":"Service security capabilities"},"fields":{"section":"istio","chapter":"service-security-capabilities"}},{"frontmatter":{"order":5,"chapterTitle":"Traffic management"},"fields":{"section":"istio","chapter":"traffic-management"}},{"frontmatter":{"order":7,"chapterTitle":"WebAssembly and intelligent data planes"},"fields":{"section":"istio","chapter":"webassembly-and-intelligent-data-planes"}}]},"serviceMeshesList":{"nodes":[{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}}]}},"pageContext":{"learnpath":"mastering-service-meshes-for-developers","slug":"learn/learning-paths/mastering-service-meshes-for-developers/advance-concepts-of-service-mesh/istio/traffic-management","course":"advance-concepts-of-service-mesh","section":"istio","chapter":"traffic-management","pageType":"chapter","frontmatter":{"docType":"Chapter","chapterTitle":"Traffic management","description":"Meshery is the cloud native management plane which offers lifecycle, configuration, and performance management of service meshes and their workloads.","videos":4,"lectures":12,"order":5}}},"staticQueryHashes":["1376321266","1485533831","2848499768","4047814605","961506260"],"matchPath":"/learn/learning-paths/mastering-service-meshes-for-developers/advance-concepts-of-service-mesh/istio/traffic-management.html"}