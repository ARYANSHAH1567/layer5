"use strict";(self.webpackChunkLayer5=self.webpackChunkLayer5||[]).push([[43191],{90933:function(e,t,n){n.r(t),n.d(t,{Head:function(){return h},default:function(){return p}});var a=n(39626),l=n(67294),r=n.p+"static/install-imagehub-21c5e9a1daac9293c028ed4d46b975ec.webp",i=n.p+"static/deploy-envoyfilter-8b97efa7d5dc0668799fbcf4864fb5e3.webp";function o(e){var t=Object.assign({p:"p",a:"a",ol:"ol",li:"li",pre:"pre",code:"code"},(0,a.ah)(),e.components),n=t.ChapterStyle;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ChapterStyle",!0),l.createElement(n,null,l.createElement(t.p,null,"In this lab, you will use the sample application ",l.createElement(t.a,{href:"https://github.com/layer5io/image-hub"},"Image Hub"),". This version of the Image Hub filter has been simplified for your lab. To self-study deeper functionality, try the other version of the Image Hub filter that is available in the Image Hub repo."),l.createElement("h2",{className:"chapter-sub-heading"},"Deploy Sample Application"),l.createElement(t.p,null,"Using Meshery, select Istio from the Management menu."),l.createElement(t.p,null,"In the Istio management page:"),l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"Type default into the namespace field."),"\n",l.createElement(t.li,null,"Click the (+) icon on the Manage Sample Application Lifecycle card and select Image Hub Application to install the latest version of Image Hub"),"\n"),l.createElement("img",{src:r,align:"center",width:"100%"}),l.createElement("br"),l.createElement("br"),l.createElement("h2",{className:"chapter-sub-heading"},"Load the filter"),l.createElement(t.p,null,"Next, load the custom Envoy filter. This filter is written in Rust and is compiled against WebAssembly as it's target runtime."),l.createElement(t.p,null,"Using Meshery, select Istio from the Management menu."),l.createElement(t.p,null,"In the Istio management page:"),l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"Type default into the namespace field."),"\n",l.createElement(t.li,null,"Click the (+) icon on the Apply Service Mesh Configuration card and select Envoy Filter for Image Hub to deploy the custom filter."),"\n"),l.createElement("img",{src:i,align:"center",width:"100%"}),l.createElement("br"),l.createElement("br"),l.createElement("h2",{className:"chapter-sub-heading"},"Send traffic"),l.createElement("br"),l.createElement("h2",{className:"chapter-sub-heading"},"Analyze behavior"),l.createElement(t.p,null,"Alternative, manual installation steps are provided for reference below. No need to execute these if you have performed the steps above."),l.createElement(t.p,null,"Manually deploy the Image Hub filter."),l.createElement(t.pre,null,l.createElement(t.code,{className:"language-yaml"},'apiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: custom-filter\nspec:\n  configPatches:\n    - applyTo: HTTP_FILTER\n      match:\n        context: SIDECAR_OUTBOUND # will match outbound listeners in all sidecars\n        listener:\n          portNumber: 9080\n          filterChain:\n            name: envoy.http_connection_manager\n            filter:\n              name: "envoy.tcp_proxy"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          # This is the full filter config including the name and config or typed_config section.\n          name: "envoy.filters.http.wasm"\n          config:\n            config:\n              name: custom-filter\n              rootId: my_root_id\n              vmConfig:\n                code:\n                  local:\n                    filename: /var/lib/imagehub/filter.wasm\n                runtime: envoy.wasm.runtime.v8\n                vmId: custom-filter\n                allow_precompiled: true\n  workloadSelector:\n    labels:\n      app: api-v1\n      version: v1\n\n')),l.createElement(t.p,null,"Manually patch the Image Hub Deployment."),l.createElement(t.pre,null,l.createElement(t.code,{className:"language-yaml"},'---(\n  // kubectl patch deployment/api-v1 -p \'\n  {\n    "spec": {\n      "template": {\n        "metadata": {\n          "annotations": {\n            "sidecar.istio.io/userVolumeMount": "[{\\"mountPath\\":\\"/var/lib/imagehub\\",\\"name\\":\\"wasm-filter\\"}]"\n          }\n        },\n        "spec": {\n          "initContainers": [\n            {\n              "command": [\n                "curl",\n                "-L",\n                "-o",\n                "/var/lib/imagehub/filter.wasm",\n                "https://github.com/layer5io/advanced-istio-service-mesh-workshop/raw/master/lab-7/ratelimiter/ratelimit-filter.wasm"\n              ],\n              "image": "curlimages/curl",\n              "imagePullPolicy": "Always",\n              "name": "add-wasm",\n              "resources": {},\n              "terminationMessagePath": "/dev/termination-log",\n              "terminationMessagePolicy": "File",\n              "volumeMounts": [\n                {\n                  "mountPath": "/var/lib/imagehub",\n                  "name": "wasm-filter"\n                }\n              ]\n            }\n          ],\n          "volumes": [\n            {\n              "emptyDir": {},\n              "name": "wasm-filter"\n            }\n          ]\n        }\n      }\n    }\n  }\n)\n// \'\n\n')),l.createElement(t.p,null,"A future version of Meshery will allow you to deploy any filter from the ",l.createElement(t.a,{href:"https://github.com/layer5io/wasm-filters"},"wasm-filters")," repo. PR the repo to upload your custom filter and have Meshery deploy it."))}var c=function(e){void 0===e&&(e={});var t=Object.assign({},(0,a.ah)(),e.components).wrapper;return t?l.createElement(t,e,l.createElement(o,e)):o(e)};var m=n(17875),s=n(5802),u=function(e){var t=e.data,n=e.location,a=t.TOC.nodes.sort((function(e,t){var n,a;return(null!==(n=e.frontmatter)&&void 0!==n&&n.order?e.frontmatter.order:100)-(null!==(a=t.frontmatter)&&void 0!==a&&a.order?t.frontmatter.order:100)}));return l.createElement(l.Fragment,null,l.createElement(s.Z,{chapterData:t.chapter,TOCData:a,courseData:t.course.nodes[0],location:n,serviceMeshesList:t.serviceMeshesList.nodes}))};function p(e){return l.createElement(u,e,l.createElement(c,e))}var h=function(e){var t=e.data;return l.createElement(m.Z,{title:t.chapter.frontmatter.chapterTitle,canonical:"https://layer5.io/learn/learning-paths"})}}}]);